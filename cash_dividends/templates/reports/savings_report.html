{% extends "base.html" %}

{% block content %}
<h1>Special Savings Report</h1>

<!-- Filter Form -->
<form method="get" class="mb-3">
    <label for="account_type">Account Type:</label>
    <select name="account_type" id="account_type">
        <option value="">All</option>
        {% for code, name in account_types %}
            <option value="{{ code }}" {% if selected_account_type == code %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
    </select>

    <label for="transaction_type">Transaction Type:</label>
    <select name="transaction_type" id="transaction_type">
        <option value="">All</option>
        {% for code, name in transaction_types %}
            <option value="{{ code }}" {% if selected_transaction_type == code %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
    </select>

    <button type="submit">Filter</button>
</form>

<!-- Export Links -->
<div class="mb-3">
    <a href="?{% if selected_account_type %}account_type={{ selected_account_type }}&{% endif %}{% if selected_transaction_type %}transaction_type={{ selected_transaction_type }}&{% endif %}export=csv">Export CSV</a> |
    <a href="?{% if selected_account_type %}account_type={{ selected_account_type }}&{% endif %}{% if selected_transaction_type %}transaction_type={{ selected_transaction_type }}&{% endif %}export=xlsx">Export XLSX</a> |
    <a href="?{% if selected_account_type %}account_type={{ selected_account_type }}&{% endif %}{% if selected_transaction_type %}transaction_type={{ selected_transaction_type }}&{% endif %}export=pdf">Export PDF</a>
</div>

<!-- Dashboard / Summary -->
<div class="dashboard-box mb-4">
    <div class="dashboard-card">
        <div class="dashboard-title">Total Balances</div>
        <div class="dashboard-value">₦{{ total_balance|floatformat:2 }}</div>
    </div>
    <div class="dashboard-card">
        <div class="dashboard-title">Total Dividends</div>
        <div class="dashboard-value">₦{{ total_dividends|floatformat:2 }}</div>
    </div>
    <div class="dashboard-card">
        <div class="dashboard-title">Total Withdrawals</div>
        <div class="dashboard-value">₦{{ total_withdrawals|floatformat:2 }}</div>
    </div>
    <div class="dashboard-card">
        <div class="dashboard-title">Total Charges</div>
        <div class="dashboard-value">₦{{ total_charges|floatformat:2 }}</div>
    </div>
</div>

<!-- Charts -->
<div id="savings-charts" class="mb-4">
    <h3>Charts & Comparisons</h3>
    <canvas id="account-type-chart" width="400" height="200"></canvas>
    <canvas id="transaction-type-chart" width="400" height="200"></canvas>
</div>

<!-- Side Panel -->
<div id="side-panel" style="position:fixed; right:0; top:0; width:350px; height:100%; background:#fff; border-left:1px solid #ccc; overflow:auto; padding:15px; display:none; z-index:999;">
    <h3>Details</h3>
    <pre id="details-content">Select an account or transaction to see details.</pre>
    <button onclick="document.getElementById('side-panel').style.display='none'">Close</button>
</div>

<!-- Accounts Table -->
<h3>Accounts</h3>
<table border="1" cellpadding="5" cellspacing="0" class="mb-4 sortable">
    <thead>
        <tr>
            <th onclick="sortTable(this,0)">User</th>
            <th onclick="sortTable(this,1)">Account Type</th>
            <th onclick="sortTable(this,2)">Balance</th>
            <th onclick="sortTable(this,3)">Total Dividends</th>
            <th onclick="sortTable(this,4)">Total Withdrawals</th>
            <th onclick="sortTable(this,5)">Total Charges</th>
            <th onclick="sortTable(this,6)">Created At</th>
        </tr>
    </thead>
    <tbody>
        {% for account in accounts %}
        <tr onclick="showDetails({{ account|json_script:'account-'|safe }})">
            <td>{{ account.user.username }}</td>
            <td>{{ account.account_type }}</td>
            <td>₦{{ account.balance|floatformat:2 }}</td>
            <td>₦{{ account.total_dividends|floatformat:2 }}</td>
            <td>₦{{ account.total_withdrawals|floatformat:2 }}</td>
            <td>₦{{ account.total_charges|floatformat:2 }}</td>
            <td>{{ account.created_at }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No accounts found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- Accounts Pagination -->
{% if accounts_paginator.num_pages > 1 %}
<div class="pagination mb-4">
    {% if accounts.has_previous %}
        <a href="?page={{ accounts.previous_page_number }}{% if selected_account_type %}&account_type={{ selected_account_type }}{% endif %}{% if selected_transaction_type %}&transaction_type={{ selected_transaction_type }}{% endif %}">Previous</a>
    {% endif %}
    Page {{ accounts.number }} of {{ accounts_paginator.num_pages }}
    {% if accounts.has_next %}
        <a href="?page={{ accounts.next_page_number }}{% if selected_account_type %}&account_type={{ selected_account_type }}{% endif %}{% if selected_transaction_type %}&transaction_type={{ selected_transaction_type }}{% endif %}">Next</a>
    {% endif %}
</div>
{% endif %}

<!-- Transactions Table -->
<h3>Transactions</h3>
<table border="1" cellpadding="5" cellspacing="0" class="mb-4 sortable">
    <thead>
        <tr>
            <th onclick="sortTable(this,0)">Account</th>
            <th onclick="sortTable(this,1)">Type</th>
            <th onclick="sortTable(this,2)">Amount</th>
            <th onclick="sortTable(this,3)">Date</th>
            <th onclick="sortTable(this,4)">Related Account</th>
            <th onclick="sortTable(this,5)">Description</th>
        </tr>
    </thead>
    <tbody>
        {% for t in transactions %}
        <tr onclick="showDetails({{ t|json_script:'tx-'|safe }})">
            <td>{{ t.account.user.username }} - {{ t.account.account_type }}</td>
            <td>{{ t.transaction_type }}</td>
            <td>₦{{ t.amount|floatformat:2 }}</td>
            <td>{{ t.date }}</td>
            <td>{{ t.related_account }}</td>
            <td>{{ t.description }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6">No transactions found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- Transactions Pagination -->
{% if transactions_paginator.num_pages > 1 %}
<div class="pagination mb-4">
    {% if transactions.has_previous %}
        <a href="?page={{ transactions.previous_page_number }}{% if selected_account_type %}&account_type={{ selected_account_type }}{% endif %}{% if selected_transaction_type %}&transaction_type={{ selected_transaction_type }}{% endif %}">Previous</a>
    {% endif %}
    Page {{ transactions.number }} of {{ transactions_paginator.num_pages }}
    {% if transactions.has_next %}
        <a href="?page={{ transactions.next_page_number }}{% if selected_account_type %}&account_type={{ selected_account_type }}{% endif %}{% if selected_transaction_type %}&transaction_type={{ selected_transaction_type }}{% endif %}">Next</a>
    {% endif %}
</div>
{% endif %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const accountsData = {{ accounts|json_script:"accounts-data" }};
const transactionsData = {{ transactions|json_script:"transactions-data" }};

// Chart Data
const accountTypeTotals = {};
accountsData.forEach(acc => { accountTypeTotals[acc.account_type] = (accountTypeTotals[acc.account_type] || 0) + parseFloat(acc.balance); });

const transactionTypeTotals = {};
transactionsData.forEach(tx => { transactionTypeTotals[tx.transaction_type] = (transactionTypeTotals[tx.transaction_type] || 0) + parseFloat(tx.amount); });

// Account Type Chart
const ctxAcc = document.getElementById('account-type-chart').getContext('2d');
new Chart(ctxAcc, {
    type: 'bar',
    data: { labels: Object.keys(accountTypeTotals), datasets: [{ label: 'Total Balance by Account Type', data: Object.values(accountTypeTotals), backgroundColor: 'rgba(54, 162, 235, 0.6)' }] },
    options: { responsive: true }
});

// Transaction Type Chart
const ctxTx = document.getElementById('transaction-type-chart').getContext('2d');
new Chart(ctxTx, {
    type: 'pie',
    data: { labels: Object.keys(transactionTypeTotals), datasets: [{ label: 'Total Amount by Transaction Type', data: Object.values(transactionTypeTotals), backgroundColor: ['#36a2eb','#ff6384','#ffcd56','#4bc0c0','#9966ff','#ff9f40'] }] },
    options: { responsive: true }
});

// Side Panel
function showDetails(objJson) {
    const panel = document.getElementById('side-panel');
    const content = document.getElementById('details-content');
    content.innerHTML = JSON.stringify(JSON.parse(document.getElementById(objJson).textContent), null, 2);
    panel.style.display = 'block';
}

// Simple Sort
function sortTable(header, colIndex) {
    const table = header.closest('table');
    const tbody = table.tBodies[0];
    Array.from(tbody.rows)
        .sort((a,b) => a.cells[colIndex].innerText.localeCompare(b.cells[colIndex].innerText, undefined, {numeric:true}))
        .forEach(row => tbody.appendChild(row));
}
</script>

<style>
.dashboard-box { display:flex; gap:20px; margin-bottom:25px; flex-wrap:wrap; }
.dashboard-card { padding:15px 20px; border-radius:8px; background:#f8f9fa; border:1px solid #ddd; width:220px; }
.dashboard-title { font-size:13px; font-weight:600; color:#666; }
.dashboard-value { font-size:22px; font-weight:bold; margin-top:5px; }
table { width:100%; border-collapse:collapse; }
th { background:#f1f1f1; cursor:pointer; }
th, td { text-align:left; padding:8px; }
tr:nth-child(even) { background:#f9f9f9; }
#side-panel pre { white-space:pre-wrap; word-wrap:break-word; }
.pagination { margin-top:10px; display:flex; justify-content:space-between; align-items:center; }
.pagination a { padding:5px 10px; background:#eee; border-radius:5px; text-decoration:none; }
</style>

{% endblock %}
