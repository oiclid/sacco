{% extends "base.html" %}
{% load json_script %}

{% block content %}
<h1>Monthly Loan Repayments Report - {{ month }}</h1>

<!-- Filters -->
<form method="get" class="mb-3">
    <label>From: <input type="date" name="from" value="{{ request.GET.from }}"></label>
    <label>To: <input type="date" name="to" value="{{ request.GET.to }}"></label>
    <label>Member: <input type="text" name="member" value="{{ request.GET.member }}" placeholder="Member username"></label>
    <button type="submit">Filter</button>
    <a href="{% url 'monthly-repayments-report' %}">Reset</a>
</form>

<!-- Export Links -->
<div class="mb-3">
    <a href="?{% querystring request GET 'export'='csv' %}">Export CSV</a> |
    <a href="?{% querystring request GET 'export'='json' %}">Export JSON</a> |
    <a href="?{% querystring request GET 'export'='xlsx' %}">Export XLSX</a> |
    <a href="?{% querystring request GET 'export'='pdf' %}">Export PDF</a>
</div>

<!-- Total Repayments Summary -->
<h2>Total Repayments: ₦{{ total|floatformat:2 }}</h2>

<!-- Transactions Table -->
<table class="table" id="repayments-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Loan Type</th>
            <th>Amount (₦)</th>
        </tr>
    </thead>
    <tbody>
        {% for tx in rows %}
        <tr>
            <td>{{ tx.date }}</td>
            <td>{{ tx.account.user.username }}</td>
            <td>{{ tx.loan.category|capfirst|replace:"_"," " }}</td>
            <td>{{ tx.amount|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4">No repayments recorded for this month.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>

<!-- Chart -->
<div style="width: 60%; margin: auto; margin-top: 40px;">
    <h3>Repayments by Loan Type</h3>
    <canvas id="repayments-chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const repaymentsData = {{ rows|json_script:"repayments-rows" }};

// Aggregate totals by loan type
const loanTypeTotals = {};
repaymentsData.forEach(r => {
    const loanType = r.loan.category;
    loanTypeTotals[loanType] = (loanTypeTotals[loanType] || 0) + r.amount;
});

const labels = Object.keys(loanTypeTotals);
const values = Object.values(loanTypeTotals);

new Chart(document.getElementById('repayments-chart'), {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
            data: values,
            backgroundColor: labels.map((_, i) => `hsl(${i*60 % 360}, 70%, 50%)`)
        }]
    },
    options: { responsive: true }
});

// Optional: Simple table sorting
document.querySelectorAll('#repayments-table th').forEach(th => {
    th.addEventListener('click', () => {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const index = Array.from(th.parentNode.children).indexOf(th);
        const ascending = !th.dataset.asc || th.dataset.asc === "false";

        rows.sort((a, b) => {
            const aText = a.children[index].innerText.replace(/,/g,'');
            const bText = b.children[index].innerText.replace(/,/g,'');
            return !isNaN(aText) && !isNaN(bText) 
                ? (ascending ? aText - bText : bText - aText) 
                : (ascending ? aText.localeCompare(bText) : bText.localeCompare(aText));
        });

        tbody.append(...rows);
        th.dataset.asc = ascending;
    });
});
</script>

<style>
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
}
th {
    background-color: #f4f4f4;
    cursor: pointer;
}
form label {
    margin-right: 10px;
}
</style>

{% endblock %}
